category: Analytics & SIEM
commonfields:
  id: VARONIS
  version: -1
configuration:
- defaultvalue: http://192.168.56.11:8000
  display: Your server URL
  name: url
  required: true
  type: 0
- display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- display: Use system proxy settings
  name: proxy
  required: false
  type: 8
- display: username
  name: auth
  required: true
  type: 9
- display: Fetch incidents
  name: isFetch
  required: false
  type: 8
- defaultvalue: "1"
  display: Incidents Fetch Interval
  name: incidentFetchInterval
  required: false
  type: 19
- display: Incident type
  name: incidentType
  required: false
  type: 13
contentitemexportablefields:
  contentitemfields:
    fromServerVersion: 5.5.0
    itemVersion: 1.0.0
    packID: Varonis
    packPropagationLabels:
    - all
    propagationLabels: []
    toServerVersion: ""
description: The Varonis integration
detaileddescription: |-
  ### Developer Contributed Integration
  #### Integration Author: Houssem ADOUNI (OCD)
  Support and maintenance for this integration are provided by the author. Please use the following contact details:
  ***
  ## BaseIntegration Help

  Markdown file for integration configuration  help snippet. In this file add:
  - Brief information about how to retrieve the API key of your product
  - Other useful information on how to configure your integration in XSOAR

  Since this is a Markdown file, we encourage you to use MD formatting for sections, sub-sections, lists, etc.



  ---
  [View Integration Documentation](https://xsoar.pan.dev/docs/reference/integrations/varonis)
display: VARONIS (Developer Contribution)
image: data:image/png;base64,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
name: VARONIS
script:
  commands:
  - arguments: []
    name: go
  dockerimage: demisto/python3:3.9.5.21272
  isfetch: true
  runonce: false
  script: |
    import sys





    import requests
    import traceback
    from typing import Dict, Any

    import datetime
    # Disable insecure warnings
    requests.packages.urllib3.disable_warnings()  # pylint: disable=no-member


    ''' CONSTANTS '''
    DATE_FORMAT = '%Y-%m-%dT%H:%M:%SZ'  # ISO8601 format with UTC, default in XSOAR


    class VaronisClient(BaseClient):
        def __init__(self, base_url, verify, proxy, username=None, password=None, ok_codes=(200, ), headers=None, auth=None):
            BaseClient.__init__(
                self,
                base_url=base_url,
                verify=verify,
                proxy=proxy,
                ok_codes=ok_codes,
                headers=headers,
                auth=auth
            )

            self.username = username
            self.password = password

            self.access_token = ""
            self.refresh_token = ""

            # set access_token and refresh_token
            self.init_tokens()

            self.headers = {
                "Accept": "application/json",
                "Content-Type": "application/json",
                "Authorization": "Bearer " + self.access_token
            }

        def init_tokens(self):
            """
            Get tokens
            """
            # import pdb; pdb.set_trace()
            response = self._http_request(
                method='get',
                url_suffix='/v2/login',
                auth=(
                    demisto.params().get('auth').get('identifier'),
                    demisto.params().get('auth').get('password')
                )
            )

            self.access_token = response.get("AccessToken")
            self.refresh_token = response.get("RefreshToken")

            return response

        def refresh_tokens(self):
            response = self._http_request(
                method='post',
                url_suffix='/v2/login',
                headers=self.headers,
                json_data={"refreshToken": self.refresh_token}
            )

            self.access_token = response.get("AccessToken")
            self.refresh_token = response.get("RefreshToken")

            return response


    # TODO delete this
    def create_incident(name):

        incidents = []
        raw_json = {
            'name': name,
            'create_time': '2019-10-23T10:11:00Z',
            'event_id': 100,
            'playbook': 'test_adouni',
            'testingdatta': 'good',
            'dett': "this is world"
        }

        incident_data = {
            'name': 'test adouni',  # name is required field, must be set
            'occurred': '2019-10-23T10:11:00Z',  # must be string of a format ISO8601
            'rawJSON': json.dumps(raw_json),
            'playbook': 'test_adouni'
        }

        incidents.append(incident_data)
        demisto.incidents(incidents)


    def test_module(client: VaronisClient) -> str:
        message: str = ''
        try:
            assert client.access_token
            assert client.refresh_token
            client.refresh_tokens()
            assert client.access_token
            assert client.refresh_token

            message = 'ok'
        except DemistoException as e:
            if 'Forbidden' in str(e) or 'Authorization' in str(e):
                message = 'Authorization Error: make sure username and password are correctly set'
            else:
                raise e
        return message


    def fetch_incidents(client):
        time = datetime.datetime.now()
        if time.minute % 2:
            typer = 'world'
        else:
            typer = 'hello'
        str_time = f'{time.hour}:{time.minute}'
        incidents = []
        raw_json = {
            'name': "name",
            'create_time': '2019-10-23T10:11:00Z',
            'event_id': 100,
            'playbook': 'test_adouni',
            'last_run': str(demisto.getLastRun()),
            'context': demisto.context(),
            'con': demisto.getIntegrationContext(),
            'inc_type': typer,
            'testingdatta': 'good',
            'dett': "this is world"
        }

        incident_data = {
            'name': f"Incident => {str_time}",  # name is required field, must be set
            'occurred': '2019-10-23T10:11:00Z',  # must be string of a format ISO8601
            'rawJSON': json.dumps(raw_json),
            'playbook': 'test_adouni'
        }
        incidents.append(incident_data)
        demisto.incidents(incidents)
        demisto.setLastRun({"world": 'world at  : ' + str_time})
        demisto.setIntegrationContext({'none': 'none'})


    def go(client):
        """
        # TODO : Delete this command
        Test command for developement
        """
        # print(f" access : {client.access_token}")
        # print(f" refresh : {client.refresh_token}")
        client.refresh_tokens()

        # print(demisto.params())

        return CommandResults(
            outputs_prefix='variable_go',
            outputs_key_field='',
            outputs='hello world',
            readable_output='hello world'
        )


    ''' MAIN FUNCTION '''


    def main() -> None:
        # TODO: make sure you properly handle authentication

        # get the service API data
        base_url = urljoin(demisto.params()['url'], '')
        verify_certificate = not demisto.params().get('insecure', False)
        proxy = demisto.params().get('proxy', False)
        username = demisto.params().get('auth').get('identifier')
        password = demisto.params().get('auth').get('password')

        demisto.debug(f'Command being called is {demisto.command()}')
        try:
            client = VaronisClient(
                base_url=base_url,
                verify=verify_certificate,
                proxy=proxy,
                username=username,
                password=password
            )

            if demisto.command() == 'test-module':
                # This is the call made when pressing the integration Test button.
                result = test_module(client)
                return_results(result)

            if demisto.command() == 'fetch-incidents':
                fetch_incidents(client)

            if demisto.command() == 'go':
                result = go(client)
                return_results(result)

        # Log exceptions and return errors
        except Exception as e:
            demisto.error(traceback.format_exc())  # print the traceback
            return_error(f'Failed to execute {demisto.command()} command.\nError:\n{str(e)}')


    ''' ENTRY POINT '''


    if __name__ in ('__main__', '__builtin__', 'builtins'):
        main()
  subtype: python3
  type: python
system: true
